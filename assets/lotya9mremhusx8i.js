import{jY as I,df as R,jS as c,lq as d,jT as w,bx as v,n_ as O,R as N,n$ as S,o0 as C,jU as f,k3 as k}from"./hml6mmd5fyx85si7.js";import{r as A}from"./lu2xqwqmjc95q6j6.js";import{bJ as P,bK as m,bL as g}from"./rseqzngxzbdt1oxg.js";import{m as b}from"./hxuke67we6ylj0az.js";function ie({composerController:a,parsedDocumentHandler:t}){const{connectorConfig:s}=I();return A.useEffect(()=>{const e=()=>{const n=T(a,s);t(n)};return e(),a.subscribe("change",e)},[a,s,t]),null}function T(a,t){const s=R(a),e=P(a),n=[];for(const o of t.values())switch(o.type){case c.GDRIVE:{if(o.link_enabled??!0){const r=$(e,o);n.push(...r),o.access_token&&r.reduce((l,u)=>l.replace(u.url,""),e)!==e&&r.forEach(({url:l})=>d(s,l,""))}break}case c.O365:break;case c.O365_BUSINESS:{const r=K(e,o).filter(i=>i!=null);o.access_token&&r.forEach(({url:i})=>d(s,i,"")),n.push(...r);break}case c.O365_PERSONAL:{const r=B(e,o).filter(i=>i!=null);o.access_token&&r.forEach(({url:i})=>d(s,i,"")),n.push(...r);break}case c.CONFLUENCE:{const r=M(e,o).filter(i=>i!=null);o.access_token&&r.forEach(({url:i})=>d(s,i,"")),n.push(...r);break}case c.JIRA:{const r=z(e,o).filter(i=>i!=null);o.access_token&&r.forEach(({url:i})=>d(s,i,"")),n.push(...r);break}case c.NOTION_OPEN_CONNECTOR:{const r=se(e,o).filter(i=>i!=null);o.access_token&&r.forEach(({url:i})=>d(s,i,"")),n.push(...r);break}case c.SLACK_OPEN_CONNECTOR:{const r=Y(e,o).filter(i=>i!=null);o.access_token&&r.forEach(({url:i})=>d(s,i,"")),n.push(...r);break}}return n.length&&w.linkPasted(b(v(n,o=>o.type),o=>o.length)),n}const x=/\bhttps:\/\/docs\.google\.com\/(document|spreadsheets|presentation)\/d\/([\w-]+)\/?(?:(?:edit|view)\/?)?(?:\?[\w\-.~%=]*)?(?:#[\w\-.~%=]*)?/gm,D=/\bhttps:\/\/drive\.google\.com\/(file)\/d\/([\w-]+)\/?(?:(?:edit|view)\/?)?(?:\?[\w\-.~%=]*)?(?:#[\w\-.~%=]*)?/gm,U="https://www.googleapis.com/auth/drive.readonly";function $(a,t){return[...a.matchAll(x),...a.matchAll(D)].map(s=>{const e={url:s[0],id:s[2],type:c.GDRIVE};return t.access_token&&t.scopes&&t.scopes.includes(U)?{...e,handler:{type:"fetch",tryFetch:async()=>{g.logAttemptIfAccessTokenIsExpired(t,f.Link);const o=`https://www.googleapis.com/drive/v3/files/${e.id}?fields=name,mimeType`,r=await fetch(o,{method:"GET",headers:{Authorization:`Bearer ${t.access_token}`,"Content-Type":"application/json"}});if(!r.ok)return Promise.reject(new Error(`HTTP ${r.status}`));const{name:i,mimeType:l}=await r.json(),u=k(l);return{connector:c.GDRIVE,id:e.id,title:i,mimeType:l,url:e.url,syntheticExtension:u}}}}:{...e,handler:{type:"prompt",message:"not-connected"}}})}function y(a){let t;try{t=new URL(a).toString()}catch{return null}return`u!${btoa(t).replaceAll("=","").replaceAll("/","_").replaceAll("+","-")}`}const j=/\bhttps:\/\/onedrive\.live\.com\/[\w\-_.~!*'();:@&=+$,\\/?%#[\]]*/gm,L=/\bhttps:\/\/photos\.onedrive\.com\/(?:share|photo)\/[\w\-_.~!*'();:@&=+$,\\/?%#[\]]*/gm,F=/\bhttps:\/\/1drv\.ms\/[\w\-_.~!*'();:@&=+$,\\/?%#[\]]*/gm;function B(a,t){return[...a.matchAll(j),...a.matchAll(F),...a.matchAll(L)].map(s=>{const e=y(s[0]);if(!e)return null;const n={url:s[0],id:e,type:c.O365_PERSONAL};return t.access_token?{...n,handler:{type:"fetch",tryFetch:_(m.OneDrive_PERSONAL_SHARES,e,t.access_token,t)}}:{...n,handler:{type:"prompt",message:"not-connected"}}})}const G=/\bhttps:\/\/([^\s]+?\.atlassian\.net)\/wiki\/spaces\/[^\s]+\/pages\/(\d+)\/([^\s]+)?/gm;function M(a,t){return[...a.matchAll(G)].map(s=>{const e=s[1],n=s[2],o=s[3];if(!n)return null;const r={url:s[0],id:n,type:c.CONFLUENCE};return t.access_token?{...r,handler:{type:"fetch",tryFetch:async()=>{let i=o;return!o&&t.access_token&&(i=await Z(t.access_token,`https://${e}`,t,n)),{connector:t.type,id:n,title:i,mimeType:"text/html",url:r.url,syntheticExtension:null,manifest:{id:n,domain:e,type:C.PAGE,manifest_type:c.CONFLUENCE}}}}}:{...r,handler:{type:"prompt",message:"not-connected"}}})}const J=/\bhttps:\/\/([^\s]+?\.atlassian\.net)\/browse\/([^\s]+)\??/gm,V=/\bhttps:\/\/([^\s]+?\.atlassian\.net)\/jira\/(?:[^\s]+\/)*projects\/(?:[^\s]+\/)+(?:[^\s]+\/?)\?selectedIssue=([^\s]+)&?/gm;function z(a,t){return[...a.matchAll(J),...a.matchAll(V)].map(s=>{const e=s[1],n=s[2];if(!n||!e)return null;const o={url:s[0],id:n,type:c.JIRA};return t.access_token?{...o,handler:{type:"fetch",tryFetch:async()=>{const r=await ee(t.access_token,`https://${e}`,t,n);return Promise.resolve({connector:t.type,id:n,title:r,mimeType:"text/markdown",url:o.url,syntheticExtension:null,manifest:{id_or_key:n,domain:e,manifest_type:c.JIRA}})}}}:{...o,handler:{type:"prompt",message:"not-connected"}}})}const H=/\bhttps:\/\/[^\s]+?\.sharepoint\.com\/[^\s]*/gm;function K(a,t){return[...a.matchAll(H)].map(s=>{const e=y(s[0]),n=m.OneDrive_BUSINESS_SHARES;if(!e)return null;const o={url:s[0],id:e,type:c.O365_BUSINESS};return t.access_token?{...o,handler:{type:"fetch",tryFetch:_(n,e,t.access_token,t)}}:{...o,handler:{type:"prompt",message:"not-connected"}}})}const q=/\bhttps:\/\/(?<domain>[^\s]+?\.(?:enterprise\.)?slack\.com)\/archives\/(?<conversation_id>[^\s/]+)\/?\??$/gm,W=/\bhttps:\/\/(?<domain>[^\s]+?\.(?:enterprise\.)?slack\.com)\/archives\/(?<conversation_id>[^\s/]+)\/p(?<message_id>[^\s?&]+)(?:\?(?:.*thread_ts=(?<thread_id>[^\s&]+)(?:&.*))?)?/gm;function Y(a,t){return[...a.matchAll(W),...a.matchAll(q)].map(s=>{const e=s.groups?.domain;if(!e)throw new Error(`No domain found in match ${JSON.stringify(s)}`);const n=s.groups?.conversation_id;if(!n)throw new Error(`No conversation ID found in match ${JSON.stringify(s)}`);const o=s.groups?.message_id;let r=null;o&&(r=`${o.slice(0,10)}.${o.slice(10)}`);const i=s.groups?.thread_id??null;let l="Conversation",u=`conversation-${n}`;r?(l="Message",u=`message-${r}`):i?(l="Thread",u=`thread-${i}`):n[0]==="D"&&(l="Direct message");const p={id:u,url:s[0],domain:e,conversationId:n,messageId:r,threadId:i,type:c.SLACK_OPEN_CONNECTOR};return t.access_token?{...p,handler:{type:"fetch",tryFetch:async()=>t.access_token?Promise.resolve({connector:t.type,id:p.id,title:l,mimeType:"application/json",url:p.url,syntheticExtension:null,manifest:{conversation_id:p.conversationId,domain:p.domain,manifest_type:c.SLACK_OPEN_CONNECTOR,message_id:p.messageId,thread_id:i,type:O.MESSAGE}}):Promise.reject(new Error("Not connected"))}}:{...p,handler:{type:"prompt",message:"not-connected"}}})}function _(a,t,s,e,n){switch(a){case m.OneDrive_BUSINESS_SHARES:case m.OneDrive_PERSONAL_SHARES:return()=>h(`${a}/${encodeURIComponent(t)}/driveItem`,s,e);case m.OneDrive_BUSINESS_DRIVE_ITEMS:return()=>h(`${a}/${encodeURIComponent(t)}`,s,e);case m.OneDrive_BUSINESS_DRIVE_ROOT:return async()=>{const o=await Q(s,t);if(!o)return Promise.reject(null);const r=`${a}:${encodeURIComponent(o)}`;return h(r,s,e)};case m.OneDrive_PERSONAL_DRIVE_ITEMS:return()=>Promise.reject(null)}}async function Q(a,t){const e=await fetch("https://graph.microsoft.com/v1.0/me/drive/root",{method:"GET",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"}});if(!e.ok)return null;const{webUrl:n}=await e.json(),r=new URL(n).pathname;return t.startsWith(r)?t.substring(r.length):t}async function h(a,t,s,e){g.logAttemptIfAccessTokenIsExpired(s,f.Link);const n=await fetch(a,{method:"GET",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}});if(!n.ok)return Promise.reject(new Error(`HTTP ${n.status}`));const{id:o,name:r,file:i,webUrl:l,...u}=await n.json();return e||(e=u.parentReference?.driveId),{connector:s.type,id:o,title:r??"",mimeType:i?.mimeType??"",url:l??"",syntheticExtension:null,o365DriveId:e}}const X="https://api.atlassian.com/oauth/token/accessible-resources";async function E(a,t,s){g.logAttemptIfAccessTokenIsExpired(s,f.Link);const n=(await fetch(X,{headers:{Authorization:`Bearer ${a}`}}).then(o=>o.json())).find(o=>o.url===t)?.id;return n||Promise.reject(new Error("Cloud ID not found"))}async function Z(a,t,s,e){const n=await E(a,t,s);return(await fetch(`https://api.atlassian.com/ex/confluence/${n}/wiki/api/v2/pages/${e}?include-version=false`,{headers:{Authorization:`Bearer ${a}`}}).then(i=>i.json())).title??"Confluence Page"}async function ee(a,t,s,e){const n=await E(a,t,s);return(await fetch(`https://api.atlassian.com/ex/jira/${n}/rest/api/2/issue/${e}?fields=summary`,{headers:{Authorization:`Bearer ${a}`}}).then(i=>i.json())).fields.summary??"Jira Issue"}const te=/\bhttps:\/\/www\.notion\.so\/(?:.*?)?(?<page_id>[a-f0-9]{32})(?:\?[\x21-\x7e]*)?/gm;function se(a,t){return[...a.matchAll(te)].map(s=>{const e=s.groups?.page_id;if(!e)return null;const n={url:s[0],id:e,type:c.NOTION_OPEN_CONNECTOR};return t.access_token?{...n,handler:{type:"fetch",tryFetch:async()=>{const o=await N.safePost("/connectors/metadata",{requestBody:{manifest:{id:e,manifest_type:c.NOTION_OPEN_CONNECTOR}}});return Promise.resolve({connector:t.type,id:e,title:o.title??"Notion Page",mimeType:"application/json",url:n.url,syntheticExtension:null,manifest:{id:e,type:S.PAGE,manifest_type:c.NOTION_OPEN_CONNECTOR}})}}}:{...n,handler:{type:"prompt",message:"not-connected"}}})}export{ie as ContextConnectorDocumentParser,y as encodeOneDriveShareUrl,T as parseDocumentURLsAndStripFromInput};
//# sourceMappingURL=lotya9mremhusx8i.js.map
