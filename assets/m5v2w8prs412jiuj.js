import{r as t,e as K,al as G,j as l,M as j}from"./lu2xqwqmjc95q6j6.js";import{V as P,er as O,M as $,lm as B,B as W,bl as T,d as _,G as U,ka as V,P as H,aj as X}from"./hml6mmd5fyx85si7.js";import{iK as z,iL as N,iM as q,b7 as L}from"./rseqzngxzbdt1oxg.js";function k(r,n){return e=>{P.addAction(`${r}.${n}`,e)}}function Z(r){return(n,e)=>{P.addError(n,{...e,name:r,status:"error"})}}const R={recording:{start:k("whisper-recording","start"),cancel:k("whisper-recording","cancel"),submit:k("whisper-recording","submit")},transcription:{request:k("whisper-transcription","request"),transcriptDelivered:k("whisper-transcription","transcriptDelivered"),error:Z("whisper-transcription"),requestSuccess:k("whisper-transcription","requestSuccess")}};class J{static async transcribe(n,e,S={}){const h=new FormData;h.append("file",n),e&&h.append("language",e);const p={durationMs:S.durationMs,language:e,fileSize:n.size},d=performance.now();return R.transcription.request(p),O.post(`${$}/transcribe`,h).then(s=>{const o=performance.now()-d;return R.transcription.requestSuccess({...p,durationMs:o}),s}).catch(s=>{const o=performance.now()-d;throw R.transcription.error(s,{...p,durationMs:o}),s})}}const Q=48e3,Y=10,F=Q*Y,ee=4e3,te=10*60*1e3,v=r=>z.setState(n=>{n.status=r}),re=r=>{const n=t.useRef(r);n.current=r;const e=t.useRef(null),S=t.useRef([]),h=t.useRef(null),p=t.useRef(null),d=t.useRef(null),s=t.useRef(new Float32Array(0)),o=t.useRef(null),b=t.useRef(null),y=t.useRef(!1),c=t.useCallback(()=>{s.current=new Float32Array,n.current.onWaveformDataUpdate(void 0)},[]),x=t.useCallback(async(i,f)=>{v("transcribing");try{let u;B()?u=new File([i],"whisper.mp3",{type:"audio/mpeg"}):u=new File([i],`whisper.${i.type.split(/[\/;]/)[1]||"mp3"}`,{type:i.type});const m=await J.transcribe(u,void 0,{durationMs:f});v("idle"),R.transcription.transcriptDelivered({durationMs:f,transcriptLength:m.text.length}),n.current.onSuccess(m.text,m.asset_pointer,m.asset_ttl),c()}catch(u){v("error"),R.transcription.error(u,{durationMs:f}),c()}},[c]),w=t.useCallback(i=>{if(!y.current)return;y.current=!1,b.current!==null&&(clearTimeout(b.current),b.current=null);const f=o.current!=null?performance.now()-o.current:void 0;i&&e.current&&(e.current.ondataavailable=null,e.current.onstop=null,v("idle"),c(),R.recording.cancel({durationMs:f}),o.current=null),e.current?.stop(),e.current?.stream.getTracks().forEach(u=>u.stop()),e.current=null,d.current?.disconnect(),d.current=null,p.current?.disconnect(),p.current=null,h.current?.close(),h.current=null,i||R.recording.submit({durationMs:f})},[c]),A=t.useCallback(()=>{c(),v("recording"),navigator.mediaDevices.getUserMedia({audio:{sampleRate:ee,channelCount:1}}).then(i=>{o.current=performance.now(),R.recording.start(),e.current=new MediaRecorder(i);const f=B();y.current=!0,f?(S.current=[],e.current.ondataavailable=g=>{g.data.size>0&&S.current.push(g.data)},e.current.onstop=async()=>{const g=new Blob(S.current,{type:"audio/mpeg-3"}),a=o.current!=null?performance.now()-o.current:void 0;await x(g,a)},e.current.start(1e3)):(e.current.ondataavailable=async g=>{const a=o.current!=null?performance.now()-o.current:void 0;await x(g.data,a)},e.current.start()),s.current=new Float32Array(F).fill(n.current.initialValue),n.current.onWaveformDataUpdate(s.current),v("recording"),b.current=window.setTimeout(()=>{w()},te);const u=new AudioContext;h.current=u;const m=u.createMediaStreamSource(i);p.current=m;const M=u.createScriptProcessor(2048,1,1);d.current=M,M.onaudioprocess=g=>{const a=g.inputBuffer.getChannelData(0);for(let C=0;C<a.length;C++)a[C]=Math.max(a[C],n.current.initialValue);const D=s.current,E=new Float32Array(D.length+a.length);if(E.set(D,0),E.set(a,D.length),E.length>F){const C=E.length-F;s.current=E.slice(C)}else s.current=E;n.current.onWaveformDataUpdate(s.current)},m.connect(M),M.connect(u.destination)}).catch(()=>{v("error"),c(),R.recording.cancel()})},[c,w,x]);return t.useEffect(()=>()=>{w(!0)},[w]),{startRecording:A,stopRecording:w}};function ce({disabled:r=!1,initialValue:n,onSuccess:e,onWaveformDataUpdate:S,onExit:h,buttonClassName:p,visualTreatment:d}){const s=K(),o=z(a=>a.status),b=t.useRef(!1),{startRecording:y,stopRecording:c}=re({onSuccess:e,onWaveformDataUpdate:S,initialValue:n}),x=G();t.useEffect(()=>()=>{c()},[c]),t.useEffect(()=>{b.current||(y(),b.current=!0)},[y]),t.useEffect(()=>{x.state!=="idle"&&c()},[x.state,c]);const w=()=>{c(!0),h()},A=d==="codex"?l.jsx(W,{type:"button",color:"ghost",size:"small",onClick:w,icon:T,disabled:r||o==="transcribing",style:{viewTransitionName:"--vt-composer-whisper-button"},children:l.jsx(j,{id:"wham.whisperModeControls.cancel",defaultMessage:"Cancel"})}):l.jsx("div",{children:l.jsx("button",{"aria-label":s.formatMessage({id:"RMraLB",defaultMessage:"Stop dictation"}),type:"button",onClick:w,disabled:r||o==="transcribing",style:{viewTransitionName:"--vt-composer-whisper-button"},className:_(d==="composer-btn"?"composer-btn":_(N,r?"opacity-30":q,p)),children:l.jsx(T,{"aria-label":s.formatMessage({id:"DFGZS4",defaultMessage:"Stop dictation"}),className:"icon",fontSize:"inherit"})})}),i=o==="transcribing",f=i?l.jsx(U,{}):l.jsx(L,{className:"icon-lg"}),u=i?s.formatMessage({id:"CyAAys",defaultMessage:"Transcribing dictation"}):s.formatMessage({id:"fcPx42",defaultMessage:"Submit dictation"}),m=()=>{H.logEvent("Whisper on Web/Windows: Clicked to end dictation"),X.logEvent("chatgpt_composer_whisper_button_clicked_end"),c()},M=a=>{a.key==="Escape"&&V(a)&&(w(),a.preventDefault())},g=d==="codex"?l.jsx(W,{type:"button",color:"secondary",size:"small",disabled:r,icon:i?U:L,onClick:m,onKeyDown:M,ref:I,children:l.jsx(j,{id:"wham.whisperModeControls.done",defaultMessage:"Done"})}):l.jsx("div",{children:l.jsx("button",{type:"button","aria-label":u,disabled:r,className:d==="composer-btn"?"composer-btn":_(N,r?"opacity-30":q,p),onClick:m,onKeyDown:M,ref:I,children:f})});return l.jsxs("div",{className:"flex gap-x-1.5",children:[A,g]})}function I(r){r?.focus()}export{ce as WhisperModeControls};
//# sourceMappingURL=m5v2w8prs412jiuj.js.map
