import{d as q,e as E,r as b,j as e,M as j}from"./lu2xqwqmjc95q6j6.js";import{a$ as N,fH as I,bg as Q,o4 as H,pN as A,R as V,Q as z}from"./hml6mmd5fyx85si7.js";import{bD as F,bC as U,ap as O,aq as W,ar as R,as as K,iA as X,aF as B,iB as Z,iC as $,bA as J,c2 as Y,bV as ee,iD as T}from"./rseqzngxzbdt1oxg.js";const se=["Not relevant","Inaccurate","Incomplete","Missing sources","I don't like it","Shouldn't have searched Google Drive","Prompt was misunderstood","Didn't like the response style","Other"],te=["Good sources","Answered my question","I like it","Other"],ae=["Not relevant","Out of date","Content is wrong"],ne=["Relevant","Up to date","Accurate"];function re(r){switch(r){case"Not relevant":return u.tagNotRelevant;case"Inaccurate":return u.tagInaccurate;case"Incomplete":return u.tagIncomplete;case"Missing sources":return u.tagMissingSources;case"I don't like it":return u.tagDontLikeIt;case"Shouldn't have searched Google Drive":return u.tagShouldntHaveSearched;case"Prompt was misunderstood":return u.tagPromptMisunderstood;case"Didn't like the response style":return u.tagDidntLikeResponseStyle;case"Other":return u.tagOther;case"Good sources":return u.tagGoodSources;case"Answered my question":return u.tagAnsweredMyQuestion;case"I like it":return u.tagLike;case"Out of date":return u.tagOutOfDate;case"Content is wrong":return u.tagContentWrong;case"Relevant":return u.tagRelevant;case"Up to date":return u.tagUpToDate;case"Accurate":return u.tagAccurate}}function G(r,f){let n;try{n=re(r)}catch{}return n?f.formatMessage(n):r}function D(r,f){return r.map(n=>({label:G(n,f),value:n}))}const u=q({tagNotRelevant:{id:"T24lap",defaultMessage:"Not relevant"},tagInaccurate:{id:"USOv/g",defaultMessage:"Inaccurate"},tagIncomplete:{id:"Lk26Q8",defaultMessage:"Incomplete"},tagMissingSources:{id:"Fng4pl",defaultMessage:"Missing sources"},tagDontLikeIt:{id:"6eAB3A",defaultMessage:"I don't like it"},tagShouldntHaveSearched:{id:"Y22bKM",defaultMessage:"Shouldn't have searched Google Drive"},tagPromptMisunderstood:{id:"NjmgTt",defaultMessage:"Prompt was misunderstood"},tagDidntLikeResponseStyle:{id:"np+P/8",defaultMessage:"Didn't like the response style"},tagOther:{id:"BK4DWm",defaultMessage:"Other"},tagGoodSources:{id:"SpXc0X",defaultMessage:"Good sources"},tagAnsweredMyQuestion:{id:"jbur49",defaultMessage:"Answered my question"},tagLike:{id:"w9iwLl",defaultMessage:"I like it"},tagOutOfDate:{id:"qzHvzr",defaultMessage:"Out of date"},tagContentWrong:{id:"gGDbwI",defaultMessage:"Content is wrong"},tagRelevant:{id:"G4D31U",defaultMessage:"Relevant"},tagUpToDate:{id:"CsRBPs",defaultMessage:"Up to date"},tagAccurate:{id:"ohD9UA",defaultMessage:"Accurate"}});function oe({citationMetadata:r,noBottomBorder:f=!1,sourceFeedback:n,setSourceFeedback:g}){const c=E(),[y,s]=b.useMemo(()=>{if(r.type!=="file")return["",""];const a=r.name.split(".");return a.length>1?[a.slice(0,-1).join("."),a[a.length-1]]:[r.name,""]},[r]),d=b.useMemo(()=>{if(r.type!=="file")return()=>null;const a=r.cloud_doc_url??r.extra?.cloud_doc_url;return a?U(a)?.Icon??(()=>null):F},[r]),m=b.useMemo(()=>{if(r.type==="file"&&r.extra?.cloud_doc_url)try{return new URL(r.extra.cloud_doc_url).hostname}catch{return}},[r]),h=b.useCallback(a=>{g({rating:a,tags:[]})},[g]);return r.type!=="file"?null:e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-row items-center justify-between py-2",children:[e.jsxs("div",{className:"max-width-full me-2 flex grow flex-row items-center overflow-hidden",children:[e.jsx(d,{className:"icon me-1.5"}),e.jsx("a",{href:r.extra?.cloud_doc_url,className:"text-token-primary flex-shrink-1 flex-grow-1 overflow-hidden text-sm text-ellipsis whitespace-nowrap",target:"_blank",rel:"noreferrer",children:y}),m&&e.jsx("div",{className:"text-token-text-secondary ms-2 text-sm",children:m})]}),e.jsxs("div",{className:"flex shrink-0 flex-row items-center",children:[e.jsx("button",{className:"hover:bg-token-main-surface-secondary rounded-md p-1",children:n?.rating==="thumbsUp"?e.jsx(O,{className:"icon text-token-text-primary",onClick:()=>h(void 0)}):e.jsx(W,{className:"icon text-token-text-secondary",onClick:()=>h("thumbsUp")})}),e.jsx("button",{className:"hover:bg-token-main-surface-secondary rounded-md p-1",children:n?.rating==="thumbsDown"?e.jsx(R,{className:"icon text-token-text-primary",onClick:()=>h(void 0)}):e.jsx(K,{className:"icon text-token-text-secondary",onClick:()=>h("thumbsDown")})})]})]}),n?.rating&&e.jsx("div",{className:"mb-4 flex flex-row",children:(n.rating==="thumbsDown"?ae:ne).map(a=>e.jsx(X,{className:"me-2",$selected:n.tags.includes(a),onClick:()=>g({...n,tags:n.tags.includes(a)?n.tags.filter(x=>x!==a):[...n.tags,a]}),children:G(a,c)},a))}),!f&&e.jsx("div",{className:"border-token-border-default w-full border-[0.5px]"})]})}function le({documentId:r,title:f,externalUrl:n,noBottomBorder:g=!1,shouldHaveBeenIncluded:c,setShouldHaveBeenIncluded:y}){const s=b.useMemo(()=>{const m=n;return m?U(m)?.Icon??(()=>null):F},[n]),d=b.useMemo(()=>{if(n)try{return new URL(n).hostname}catch{return}},[n]);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-row items-center justify-between py-2",children:[e.jsxs("div",{className:"max-width-full me-2 flex grow flex-row items-center overflow-hidden",children:[e.jsx(s,{className:"icon me-1.5"}),e.jsx("a",{href:n,className:"text-token-primary flex-shrink-1 flex-grow-1 overflow-hidden text-sm text-ellipsis whitespace-nowrap",target:"_blank",rel:"noreferrer",children:f}),d&&e.jsx("div",{className:"text-token-text-secondary ms-2 text-sm",children:d})]}),e.jsx("div",{className:"flex shrink-0 flex-row items-center px-2",children:e.jsx(B,{checked:c,onChange:m=>y?.(m.currentTarget.checked),id:`should-have-been-included-${r}`})})]}),!g&&e.jsx("div",{className:"border-token-border-default w-full border-[0.5px]"})]})}function ie(r,f){const{messageId:n}=f;let g=n;const c=[];for(;g;){const y=r.getNodeByIdOrMessageId(g);if(!y){g=null;break}const s=y.message;if(!s)continue;const d=Z(s)??"",m=Array.isArray(s.metadata?.citations)?s.metadata.citations:[],h=Array.isArray(s.metadata?.attachments)?s.metadata.attachments:[],a={id:String(s.id),author:s.author.role,recipient:s.recipient??"",createTime:s.create_time,updateTime:s.update_time};switch(s.author.role){case N.System:c.push({...a,type:"system",content:s.content,citations:m,attachments:h});break;case N.Assistant:if(s.recipient&&["user","all"].includes(s.recipient)&&d)c.push({...a,type:"visible_text",text:d,citations:m,attachments:h});else if(s.recipient&&s.recipient.includes("file_search")){const x=s.metadata?.command??"";let v=[];try{const _=JSON.parse(d);typeof _=="object"&&_!=null&&Array.isArray(_.queries)&&(v=_.queries.map(S=>String(S)))}catch{}v?c.push({...a,type:"query",command:x,content:s.content,queries:v}):c.push({...a,type:"generic_file_search_tool",command:x,content:s.content})}break;case N.User:(d||h.length>0)&&c.push({...a,type:"visible_text",text:d,citations:m,attachments:h});break;case N.Tool:if(s.author.name?.includes("file_search")&&s.recipient==="all"){const x=s.metadata?.command??"";if(x==="msearch"&&s.content.content_type===I.TetherBrowsingDisplay){const v=s.content.result,_=s.metadata?.cloud_doc_urls;if(v){let S=null;const k=s.metadata?.raw_response;if(typeof k=="object"&&k!=null)try{S=$(k)}catch{}c.push({...a,type:"result",command:x,content:s.content,result:J(v,_),searchResponse:S})}}else x==="context_stuff"&&s.content.content_type===I.TetherQuote?c.push({...a,type:"fetch",command:x,content:s.content}):c.push({...a,type:"generic_file_search_tool",command:x,content:s.content})}break}g=y.parentId||null}return f.orderRootToLeaf&&c.reverse(),{messages:c}}const ce="considered-source-should-have-been-used";function fe({citations:r,rating:f,onClose:n,messageId:g,conversationId:c,nodeId:y,conversationTree:s}){const d=E(),m=Q(),h=H(),[a,x]=b.useState(""),[v,_]=b.useState(()=>{const t={};for(const i of r)i.metadata?.type==="file"&&(t[i.metadata.id]={rating:void 0,tags:[],url:i.metadata.extra?.cloud_doc_url});return t}),S=s?.getNodeByIdOrMessageId(g).message,k=b.useMemo(()=>{const t=new Set,i=[];for(const l of S?.metadata?.citations??[])!l.metadata||l.metadata.type!=="file"||t.has(l.metadata.id)||(i.push(l.metadata),t.add(l.metadata.id));for(const l of S?.metadata?.content_references??[])if(l.type==="file_navlist")for(const o of l.items)t.has(o.id)||(i.push({type:"file",id:o.id,name:o.name,source:"my_files",text:o.description,cloud_doc_url:o.cloud_doc_url,extra:{cloud_doc_url:o.cloud_doc_url}}),t.add(o.id));return i},[S]),[C,L]=b.useState(!0),M=b.useMemo(()=>{const t={hasQuery:!1,lastAssistantMessage:null,lastUserMessage:null,referencedSyncedFiles:[]};if(!s||!y||!s.containsNodeOrMessageId(y))return t;const i=ie(s,{messageId:y});for(const l of i.messages)switch(l.type){case"fetch":case"generic_file_search_tool":case"system":continue;case"result":{l.result.chunks.forEach(o=>{o.documentId&&!t.referencedSyncedFiles.some(p=>p.fileId===o.documentId)&&!k.some(p=>p.type==="file"&&p.id===o.documentId)&&t.referencedSyncedFiles.push({fileId:o.documentId,title:o.title,url:o.cloudDocUrl})});continue}case"query":{t.hasQuery=!0;continue}case"visible_text":{if(l.author===N.User){if(!t.lastUserMessage){const o=A(s,l.id),p=o[o.length-1].messages,w=p[p.length-1];t.lastUserMessage=w}}else if(l.author===N.Assistant&&!t.lastAssistantMessage){const o=A(s,l.id),p=o[o.length-1].messages,w=p[p.length-1];t.lastAssistantMessage=w,t.lastUserMessage=null}continue}}return t},[s,k,y]),P=b.useCallback(async t=>{const i={...t,additionalSources:a,sourcesFeedback:v,consentedToShareConvoLink:C};try{await V.safePost("/ca/feedback",{requestBody:{feedback_format:h,message_id:g,conversation_id:c,text:i.textFeedback,rating:f,tags:i.tags.map(l=>l.value),tag_choices:i.tagChoices,additional_sources:i.additionalSources,sources_feedback:i.sourcesFeedback,consented_to_share_convo_link:i.consentedToShareConvoLink}}),m.success(d.formatMessage({id:"ZzqQBa",defaultMessage:"Thanks for providing feedback!"})),n()}catch(l){l instanceof z&&m.danger(d.formatMessage({id:"4d5bOS",defaultMessage:"There was an error submitting your feedback. Please try again later."}))}},[a,v,C,h,g,c,f,m,d,n]);return e.jsxs(Y,{multiple:!0,allowEmptySubmit:!0,onSubmit:P,onCancel:n,tagOptions:D(f==="thumbsDown"?se:te,d),modalOnly:!0,modalTitle:e.jsxs("div",{className:"flex items-center gap-2",children:[f==="thumbsDown"?e.jsx(R,{className:"mb-[-6px]"}):e.jsx(O,{className:"mb-[-6px]"}),e.jsx(j,{id:"h5nasL",defaultMessage:"Provide feedback"})]}),children:[k.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("h3",{className:"mt-6 text-base font-semibold",children:e.jsx(j,{id:"G6+7UX",defaultMessage:"Sources"})}),e.jsx("div",{children:k.map((t,i)=>t?.type!=="file"?null:e.jsx(oe,{citationMetadata:t,noBottomBorder:i===k.length-1,sourceFeedback:v[t.id],setSourceFeedback:l=>_(o=>({...o,[t.id]:{...l,url:t.extra?.cloud_doc_url}}))},t.id))})]}),M.referencedSyncedFiles.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mt-6 flex items-baseline justify-between",children:[e.jsxs("div",{className:"flex-start flex",children:[e.jsx("h3",{className:"text-base font-semibold",children:e.jsx(j,{id:"xvBe/T",defaultMessage:"Considered Sources"})}),e.jsx("p",{className:"text-token-text-secondary ms-2",children:e.jsx(j,{id:"nX81fN",defaultMessage:"({numSources} sources)",values:{numSources:M.referencedSyncedFiles.length}})})]}),e.jsx("p",{className:"text-token-text-tertiary text-sm",children:e.jsx(j,{id:"0+Uivl",defaultMessage:"Good Source?"})})]}),e.jsx("div",{className:"mt-2 max-h-[200px] overflow-auto",children:M.referencedSyncedFiles.map((t,i)=>e.jsx(le,{title:t.title,documentId:t.fileId,externalUrl:t.url,noBottomBorder:i===M.referencedSyncedFiles.length-1,shouldHaveBeenIncluded:!!v[t.fileId],setShouldHaveBeenIncluded:l=>_(o=>{const p={...Object.fromEntries(Object.entries(o).filter(([w])=>w!==t.fileId))};return l&&(p[t.fileId]={tags:[ce],rating:"thumbsUp",url:t.url}),p})},t.fileId))})]}),e.jsxs("div",{className:"mt-6",children:[e.jsx("p",{className:"text-token-text-primary text-sm",children:e.jsx(j,{id:"1ApJVo",defaultMessage:"Add any additional sources"})}),e.jsx(ee,{name:"feedback",className:"mt-2",placeholder:d.formatMessage({id:"CAFeedbackModal.additionalSourcePlaceholder",defaultMessage:"(Optional) Additional sources"}),value:a,onChange:t=>x(t.target.value)})]}),e.jsxs("div",{className:"mt-6",children:[e.jsx("h3",{className:"mb-2 text-base font-semibold",children:e.jsx(j,{id:"9NcQBu",defaultMessage:"Latest Exchange"})}),e.jsx("div",{className:"p-2",children:e.jsxs("div",{className:"mb-4",children:[M.lastUserMessage&&e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-token-text-secondary mb-1 ps-4 text-xs",children:e.jsx(j,{id:"QTWrtR",defaultMessage:"Your message"})}),e.jsx("div",{className:"flex justify-start",children:e.jsx("p",{className:"dark:bg-token-main-surface-secondary relative max-w-[var(--user-chat-width,70%)] rounded-3xl bg-[#f4f4f4] px-5 py-2.5",children:M.lastUserMessage?e.jsx(T,{message:M.lastUserMessage,isCompletionInProgress:!1,hasActiveRequest:!1,clientThreadId:c,isFinalUserTurn:!1,isUserTurn:!1,turnIndex:0,isFeedbackEnabled:!1}):null})})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("p",{className:"text-token-text-secondary mb-1 ps-4 text-xs",children:e.jsx(j,{id:"ZCTm4h",defaultMessage:"ChatGPT's response"})}),e.jsx("div",{className:"bg-token-main-surface-secondary relative rounded-lg p-4 text-sm",children:M.lastAssistantMessage?e.jsx(T,{message:M.lastAssistantMessage,isCompletionInProgress:!1,hasActiveRequest:!1,clientThreadId:c,isFinalUserTurn:!1,isUserTurn:!1,turnIndex:1,isFeedbackEnabled:!1}):null})]})]})}),e.jsxs("div",{className:"mt-4",children:[e.jsx("h3",{className:"mt-6 text-base font-semibold",children:e.jsx(j,{id:"c95uEW",defaultMessage:"Full conversation"})}),e.jsx("p",{className:"text-token-text-secondary mt-1 mb-2 text-sm",children:e.jsx(j,{id:"3E3ZSm",defaultMessage:"If previous portions of this conversation are important to understand your feedback, we encourage you to include it."})}),e.jsx(B,{id:"consented-to-share-entire-convo",label:d.formatMessage({id:"5CC8r8",defaultMessage:"Share Entire Conversation"}),checked:C,onChange:t=>{L(t.currentTarget.checked)}})]})]})]})}export{fe as C,ce as a,G as g};
//# sourceMappingURL=b8n8jhgrdn0u9j3x.js.map
