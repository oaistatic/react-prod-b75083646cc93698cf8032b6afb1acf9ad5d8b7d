import{oa as v,bg as U,ob as k,oc as L,l5 as S,od as w,oe as B,ao as M,R as F}from"./hml6mmd5fyx85si7.js";import{cE as O}from"./rseqzngxzbdt1oxg.js";import{L as V}from"./gy64pge8qevmvg7e.js";import{r as p,e as C,d as j,v as Q}from"./lu2xqwqmjc95q6j6.js";function h(){if("MediaSource"in window){const e=o=>v(o)&&MediaSource.isTypeSupported(o);if(e("audio/aac"))return"aac";if(e("audio/mpeg"))return"mp3";if(e("audio/ogg"))return"opus"}}function N({conversationId:e,messageId:o}){const{voiceName:n}=O(),u=()=>F.safeGet("/synthesize",{parameters:{query:{message_id:o,conversation_id:e,voice:n,format:h()}},skipJsonTransform:!0}),t=`${e}.${o}.${n}`;return T(u,t)}function T(e,o){const[n,u]=p.useState(!1),t=p.useRef({isMediaSourceAvailable:P(),mediaSourceFormat:h()??"n/a",playPromise:null,shouldAbortQueuedPlayback:!1}).current,r=C(),d=U(),g=k(),s=L(a=>a.isPlaying&&a.sourceUrl===c.get(o)?.src),i=p.useCallback(async()=>{if(!g||!e)return;u(!0);const a={isMediaSourceAvailable:t.isMediaSourceAvailable,format:t.mediaSourceFormat};try{const f=await _({key:o,onStreamingError:y=>{S.readAloud.error(y,a),u(!1),d.danger(r.formatMessage(A.playbackError,{error:y.message}),{toastId:"useVoiceReadAloudAudio_onStreamingError",loggingTitle:A.playbackError.defaultMessage,loggingDescription:y.message})},onStreamingStart:()=>{u(!1)},fetchAudioDataResponse:e});if(t.shouldAbortQueuedPlayback){t.shouldAbortQueuedPlayback=!1;return}g.changeSource(f),t.playPromise=g.play()}catch(f){S.readAloud.error(f,a),u(!1),d.danger(r.formatMessage(A.playbackError,{error:f.message}),{toastId:"useVoiceReadAloudAudio_onStreamingError",loggingTitle:A.playbackError.defaultMessage,loggingDescription:f.message})}},[g,t,o,d,r,e]),b=p.useCallback(()=>{const a=w();a&&(t.playPromise?t.playPromise.then(()=>{a.stop(),t.playPromise=null}):a.stop())},[t]),l=p.useCallback(()=>{const a=w();a&&(a.state.isPlaying&&a.state.sourceUrl===c.get(o)?.src?b():(S.readAloud.click({isMediaSourceAvailable:t.isMediaSourceAvailable,format:t.mediaSourceFormat}),i()))},[o,t,i,b]);p.useEffect(()=>{n&&s&&u(!1)},[n,s]);const m=p.useRef(o);return p.useEffect(()=>{m.current=o}),p.useEffect(()=>(t.shouldAbortQueuedPlayback=!1,()=>{const a=B();a.isPlaying&&a.sourceUrl===c.get(m.current)?.src?b():t.shouldAbortQueuedPlayback=!0}),[t,b]),{togglePlayback:l,isPlaying:s,isLoading:n}}async function R(e){const o=await e(),n=o.headers.get("content-type")??"audio/aac";return{response:o,format:n}}async function _(e){return P()?q(e):$(e)}async function $({key:e,fetchAudioDataResponse:o}){const n=c.get(e);if(n?.blob)return n.src;const{response:u,format:t}=await R(o),r=await u.arrayBuffer(),d=new Blob([r],{type:t}),g=E({key:e,src:URL.createObjectURL(d),format:t,blob:d});return c.set(e,g),g.src}async function q({key:e,onStreamingError:o,onStreamingStart:n,fetchAudioDataResponse:u}){let t=c.get(e);t?.streaming&&(c.delete(e),t=null);let r,d;const g=D(),s=new g;if(t)r=t,r.src=URL.createObjectURL(s);else{const{format:l,response:m}=await R(u);d=m,r=E({key:e,src:URL.createObjectURL(s),format:l})}const i=x(r.id),b={sourceopen:async()=>{i("sourceopen");const l=s.addSourceBuffer(r.format),m=async()=>{l.updating&&await new Promise(a=>l.addEventListener("updateend",a,{once:!0}))};if(r.segments.length&&!r.streaming){i("streaming from cache"),r.streaming=!0,n();for(const a of r.segments)l.appendBuffer(a),await m();s.readyState==="open"&&s.endOfStream(),r.streaming=!1,i("done streaming from cache");return}if(d){i("fetching audio");try{const a=d.body?.getReader();if(!a)return;for(;c.get(e)?.id===r.id;){const{done:f,value:y}=await a.read();if(f){i("done streaming"),r.streaming=!1,s.readyState==="open"&&s.endOfStream();break}if(!Array.from(s.sourceBuffers).includes(l)){i("stop streaming, source buffer removed"),r.streaming=!1;break}r.streaming||(i("start streaming"),r.streaming=!0,n()),l.appendBuffer(y),r.segments.push(y),await m()}}catch(a){if(i("error while streaming",a),r.streaming=!1,s.readyState==="open")try{s.endOfStream("network")}catch(f){S.readAloud.error(f)}c.delete(e),o(a)}}},sourceclose:()=>{i("sourceclose"),r.streaming&&(r.streaming=!1,c.get(e)?.id===r.id&&(i("sourceclosed while streaming, cleaning up cache"),c.delete(e)))},sourceended:M};for(const[l,m]of Object.entries(b))s.addEventListener(l,()=>{try{return m()}catch(a){S.readAloud.error(a)}});return c.set(e,r),r.src}const A=j({playbackError:{id:"useVoiceReadAloudAudio.playbackError",defaultMessage:"Failed to play message"}}),x=e=>M;function D(){return P()?window.MediaSource:null}function P(){return!!h()}const E=e=>({id:Q(),segments:[],streaming:!1,...e}),c=new V({capacity:50,dispose:e=>{URL.revokeObjectURL(e.src)}});export{T as a,h as g,N as u};
//# sourceMappingURL=cdnu0xlioh6eeshn.js.map
