import{e as A,o as M}from"./ktoofw7mjru0a6r5.js";import{ca as P,ee as $,gg as R,hT as j,eg as O,cM as Q}from"./hml6mmd5fyx85si7.js";import{r as S,l as q,e as K}from"./lu2xqwqmjc95q6j6.js";import{eB as _}from"./rseqzngxzbdt1oxg.js";function U(e){const r=S.useMemo(()=>e.join("\0"),[e]);return S.useMemo(()=>e,[r])}function F(e,r,o){const a=K(),[i,m]=S.useState(o?a.formatMessage({id:"wham.useStreamTurn.preparingTask",defaultMessage:"Working on your task"}):""),[u,t]=S.useState(i);S.useEffect(()=>{const f=R(()=>t(i),200);return f(),f.cancel},[i]);const s=S.useMemo(()=>`last-event-${e}-${o??""}-${Math.random().toString(36).slice(2)}`,[e,o]);return z(e,o,["task_turn_event"],{enabled:!!o&&!M(r),subscriberId:s,onEvent:f=>m(f.task_turn_event.text)}),u}function z(e,r,o,{enabled:a=!0,subscriberId:i,onEvent:m,onComplete:u}){const t=_(m),s=_(u),f=U(o),l=q(),c=S.useCallback(p=>{t.current(p)},[t]),n=S.useCallback(()=>{s.current?.()},[s]);S.useEffect(()=>{if(!(!r||!a))return C.retainTurnStream(l,e,r,i,f,c,n),()=>{C.releaseTurnStream(e,r,i)}},[e,r,i,f,a,l,c,n])}async function*B({taskId:e,turnId:r,abortSignal:o,types:a}){let m=window.location.origin+`/backend-api/wham/tasks/${e}/turns/${r}/stream`;if(a.length>0){const t=a.map(s=>`item_type=${encodeURIComponent(s)}`).join("&");m+=`?${t}`}const u=j(m,{method:"GET",signal:o,headers:{...O({isAuthOptional:!1}),"Content-Type":"text/event-stream"},observer:{onClose:(t,s)=>{if(s&&!E(s))throw s}}});try{for await(const t of u){const s=D(t);s&&(!a||a.includes(s.item_type)?yield s:Q.warn("Unknown event type",{event:t}))}}catch(t){if(E(t))return;throw t}}function D(e){return!("data"in e)||!e.data||e.event==="heartbeat"?null:e.data}function E(e){return!!e&&typeof e=="object"&&e.name==="AbortError"}const k=P($(()=>({turnStreams:{}}))),T=k.getState,g=k.setState;function v(e,r){return`${e}:${r}`}const w=20;function G(e,r,o,a){let i;return g(m=>{const u=m.turnStreams[r];if(!u)return;if(u.initPromise){i=u.initPromise;return}const{abortController:t}=u,f=(async()=>{let l=0;const c=n=>{const p=[];g(h=>{const d=h.turnStreams[r];d&&(d.seenEventIds.has(n.id)||(d.seenEventIds.add(n.id),d.emittedEvents.push(n),Object.values(d.subscribers).forEach(b=>{if(!b.types.includes(n.item_type))return;const y=b.lastTimestamps[n.item_type];y&&n.timestamp<=y||(b.lastTimestamps[n.item_type]=n.timestamp,p.push(b.onEvent))})))}),p.forEach(h=>h(n))};for(;!t.signal.aborted&&l<w;){try{const b=B({taskId:o,turnId:a,abortSignal:t.signal,types:["task_turn_event","work_log_message","log","task_title_generated"]});for await(const y of b){if(t.signal.aborted)break;c(y)}}catch(b){if(E(b)||t.signal.aborted)break}const n=A(o,a),p=await e.fetchQuery(n),h=M(p.turn.turn_status);if(h&&e.refetchQueries({queryKey:["wham","task",o]}),l+=1,l>=w||t.signal.aborted||h)break;const d=Math.min(16e3,1e3*2**l)+Math.random()*500;await new Promise(b=>setTimeout(b,d))}if(!t.signal.aborted){const n=T().turnStreams[r]?.subscribers;Object.values(n??{}).forEach(p=>{p.onComplete?.()})}})().finally(()=>{g(l=>{const c=l.turnStreams[r];c&&c.initPromise===f&&(c.initPromise=null,Object.keys(c.subscribers).length||delete l.turnStreams[r])})});u.initPromise=f,i=f}),i??T().turnStreams[r]?.initPromise??Promise.resolve()}const C={async retainTurnStream(e,r,o,a,i,m,u){const t=v(r,o);let s=!1;g(l=>{let c=l.turnStreams[t];c?c.initPromise||(s=!0,c.abortController=new AbortController):(s=!0,c={subscribers:{},abortController:new AbortController,initPromise:null,emittedEvents:[],seenEventIds:new Set},l.turnStreams[t]=c);const n=c.subscribers[a];n?(n.types=Array.from(i),n.onEvent=m,n.onComplete=u):c.subscribers[a]={subscriberId:a,types:Array.from(i),onEvent:m,onComplete:u,lastTimestamps:{}}});const f=T().turnStreams[t].emittedEvents;for(const l of f)i.includes(l.item_type)&&m(l);s&&await G(e,t,r,o)},releaseTurnStream(e,r,o){const a=v(e,r);let i=!1,m;g(u=>{const t=u.turnStreams[a];!t||!t.subscribers[o]||(delete t.subscribers[o],Object.keys(t.subscribers).length||(i=!0,m=t.abortController,delete u.turnStreams[a]))}),i&&m&&m.abort()}};function J(e,r){return!e||e.length<=r?e:e.slice(0,r/2)+"â€¦"+e.slice(-r/2)}export{z as a,E as i,J as m,F as u};
//# sourceMappingURL=d8r48c27g352nr7t.js.map
